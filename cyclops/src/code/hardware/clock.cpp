//----------------------------------------------------------------------------------------------------------------------
// Cyclops project, autonomous RC Car
// Created by Carmelo J. Fernández-Agüera Tortosa (a.k.a. Technik)
// on February 2nd, 2012
//----------------------------------------------------------------------------------------------------------------------
// System clock

#include "clock.h"

#include <avr/interrupt.h>
#include <avr/io.h>

//----------------------------------------------------------------------------------------------------------------------
// Global data
//----------------------------------------------------------------------------------------------------------------------
volatile u32 gTicksH = 0; // High word of tick count (low word is timer 1 register)

//----------------------------------------------------------------------------------------------------------------------
// Interrupt handler
//----------------------------------------------------------------------------------------------------------------------
ISR(TIMER1_OVF_vect)
{
	++gTicksH;	// Increase on buffer overflow
}

namespace hardware { namespace clock
{
	//------------------------------------------------------------------------------------------------------------------
	void init ()
	{
		TCCR1B |= 1 << 1; // Clock source equals system clock / 8, 0.5 uS per tick
		TIMSK1 |= 1 << 0; // Enable overflow interrupt
	}

	//------------------------------------------------------------------------------------------------------------------
// 	void reset ()
// 	{
// 		gTicksH = 0;// Reset stored time
// 		TCNT1 = 0;	// Reset timer register
// 	}

	//------------------------------------------------------------------------------------------------------------------
	u32 micros ()
	{
		return (gTicksH << 15) | (TCNT1 >> 1); // Return nTicks / 2
	}

	//------------------------------------------------------------------------------------------------------------------
	u32 millis ()
	{
		return micros() / 1000;
	}

	//------------------------------------------------------------------------------------------------------------------
	u32 seconds ()
	{
		return micros() / 1000000;
	}
	
	//------------------------------------------------------------------------------------------------------------------
	void delayMS(u16 _ms)
	{
		u32 ms = millis();
		while((millis() - ms) < _ms)
		{}
	}
	
	//------------------------------------------------------------------------------------------------------------------
	void delayUS(u16 _us)
	{
		u32 us = micros();
		while((micros() - us) < _us)
		{}
	}
}	// namespace clock
}	// namespace hardware
